{% extends 'base.html' %}
{% load static %}
{% block title %}Reset Password{% endblock %}

{% block body %}
<div class="container py-5" style="max-width: 480px;">
  <div class="card shadow-sm p-4">
    <h2 class="mb-4 text-center">Set Your Email and New Password</h2>

    <form method="POST" id="resetForm" novalidate>
      {% csrf_token %}

      <div class="mb-3">
        <label for="email" class="form-label fw-semibold">Email address</label>
        <input type="email" class="form-control" name="email" id="email" placeholder="you@example.com" required>
      </div>

      <div class="d-grid mb-3">
        <button type="button" class="btn btn-primary" id="sendOtpBtn" onclick="sendOTP()">Send OTP</button>
      </div>

      <div class="mb-3">
        <label for="otp" class="form-label fw-semibold">Enter OTP</label>
        <input type="text" class="form-control" name="otp" id="otp" disabled maxlength="6" autocomplete="one-time-code" required placeholder="6-digit OTP">
      </div>

      <div class="mb-3">
        <label for="password1" class="form-label fw-semibold">New Password</label>
        <input type="password" class="form-control" name="password1" id="password1" disabled autocomplete="new-password" required placeholder="Enter new password">
      </div>

      <div class="mb-3">
        <label for="password2" class="form-label fw-semibold">Confirm New Password</label>
        <input type="password" class="form-control" name="password2" id="password2" disabled autocomplete="new-password" required placeholder="Confirm new password">
      </div>

      <div class="d-grid">
        <button type="submit" class="btn btn-success" id="submitBtn" disabled>Set Password & Email</button>
      </div>

      <div id="message" class="mt-3 text-center fw-semibold"></div>
    </form>
  </div>
</div>

<script>
  function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
      const cookies = document.cookie.split(';');
      for (let i = 0; i < cookies.length; i++) {
        const cookie = cookies[i].trim();
        if (cookie.substring(0, name.length + 1) === (name + '=')) {
          cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
          break;
        }
      }
    }
    return cookieValue;
  }

  function sendOTP() {
    const email = document.getElementById('email').value.trim();
    const sendOtpBtn = document.getElementById('sendOtpBtn');
    const otpInput = document.getElementById('otp');
    const msgDiv = document.getElementById('message');

    if (!email) {
      alert('Please enter your email.');
      return;
    }

    fetch("{% url 'verify_otp' %}", {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        "X-CSRFToken": getCookie('csrftoken')
      },
      body: JSON.stringify({ email: email })
    })
    .then(response => response.json())
    .then(data => {
      msgDiv.style.color = data.success ? 'green' : 'red';
      msgDiv.textContent = data.message;

      if (data.success) {
        sendOtpBtn.disabled = true;
        otpInput.disabled = false;
        otpInput.focus();
      }
    })
    .catch(() => {
      msgDiv.style.color = 'red';
      msgDiv.textContent = "Error sending OTP. Try again.";
    });
  }

  document.getElementById('otp').addEventListener('input', function () {
    const otp = this.value.trim();
    const email = document.getElementById('email').value.trim();
    const msgDiv = document.getElementById('message');

    if (otp.length === 6) {
      fetch("{% url 'verify_otp_check' %}", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "X-CSRFToken": getCookie('csrftoken')
        },
        body: JSON.stringify({ email: email, otp: otp })
      })
      .then(res => res.json())
      .then(data => {
        if (data.valid) {
          msgDiv.style.color = 'green';
          msgDiv.textContent = "OTP verified! You can now set your new password.";

          document.getElementById('email').readOnly = true;
          this.readOnly = true;

          document.getElementById('password1').disabled = false;
          document.getElementById('password2').disabled = false;
          document.getElementById('submitBtn').disabled = false;
          document.getElementById('password1').focus();
        } else {
          msgDiv.style.color = 'red';
          msgDiv.textContent = "Invalid OTP.";

          document.getElementById('password1').disabled = true;
          document.getElementById('password2').disabled = true;
          document.getElementById('submitBtn').disabled = true;
        }
      })
      .catch(() => {
        msgDiv.style.color = 'red';
        msgDiv.textContent = "Error verifying OTP.";
      });
    } else {
      msgDiv.textContent = "";
      document.getElementById('password1').disabled = true;
      document.getElementById('password2').disabled = true;
      document.getElementById('submitBtn').disabled = true;
    }
  });
</script>
{% endblock %}
